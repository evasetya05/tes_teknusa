{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Grafik Performance Leads{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        background: #fff;
        border-radius: 16px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.06);
        padding: 24px;
        margin-bottom: 2rem;
        height: 400px;
        display: flex;
        flex-direction: column;
    }

    .chart-container h3 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 1rem;
    }

    .chart-canvas {
        flex: 1;
        width: 100%;
    }

    .chart-grid {
        display: grid;
        gap: 2rem;
        margin-top: 2rem;
    }

    @media (min-width: 768px) {
        .chart-grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    @media (min-width: 1200px) {
        .chart-grid {
            grid-template-columns: 1fr 1fr 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>Grafik Performance Leads</h1>
        <p class="text-muted mb-0">Visualisasi tren dan distribusi data leads untuk analisis performa.</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'leads:lead_analysis' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>
            Kembali ke Analisis
        </a>
        <a href="{% url 'leads:lead_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-list me-1"></i>
            Daftar Lead
        </a>
    </div>
</div>

<div class="chart-grid">
    <div class="chart-container">
        <h3>Tren Lead Baru & Interaksi (14 Hari)</h3>
        <canvas id="trendChart" class="chart-canvas"></canvas>
    </div>

    <div class="chart-container">
        <h3>Distribusi Status Lead</h3>
        <canvas id="statusChart" class="chart-canvas"></canvas>
    </div>

    <div class="chart-container">
        <h3>Sumber Lead Terbaik</h3>
        <canvas id="sourceChart" class="chart-canvas"></canvas>
    </div>

    <div class="chart-container">
        <h3>Conversion Funnel</h3>
        <canvas id="funnelChart" class="chart-canvas"></canvas>
    </div>

    <div class="chart-container">
        <h3>Lead per Sales Owner</h3>
        <canvas id="ownerChart" class="chart-canvas"></canvas>
    </div>

    <div class="chart-container">
        <h3>Lead per Prioritas</h3>
        <canvas id="priorityChart" class="chart-canvas"></canvas>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Trend Chart (Line)
    const trendCtx = document.getElementById('trendChart');
    if (trendCtx) {
        const trendLabels = {{ charts.labels|safe }};
        const leadData = {{ charts.lead_counts|safe }};
        const interactionData = {{ charts.interaction_counts|safe }};

        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendLabels,
                datasets: [{
                    label: 'Lead Baru',
                    data: leadData,
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Interaksi',
                    data: interactionData,
                    borderColor: '#f97316',
                    backgroundColor: 'rgba(249, 115, 22, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } }
            }
        });
    }

    // Status Chart (Doughnut)
    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
        const statusData = {{ breakdown.status|safe }};
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: statusData.map(item => item.label),
                datasets: [{
                    data: statusData.map(item => item.count),
                    backgroundColor: [
                        '#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#84cc16'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    // Source Chart (Bar)
    const sourceCtx = document.getElementById('sourceChart');
    if (sourceCtx) {
        const sourceData = {{ breakdown.sources|safe }};
        new Chart(sourceCtx, {
            type: 'bar',
            data: {
                labels: sourceData.map(item => item.label),
                datasets: [{
                    data: sourceData.map(item => item.count),
                    backgroundColor: '#3b82f6'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
            }
        });
    }

    // Funnel Chart (Custom - using bar for simplicity)
    const funnelCtx = document.getElementById('funnelChart');
    if (funnelCtx) {
        const funnelLabels = ['New', 'Contacted', 'Qualified', 'Proposal', 'Negotiation', 'Won'];
        const funnelCounts = [
            {{ metrics.active_leads }},
            {{ metrics.pending_followups }},
            {{ metrics.active_leads|add:metrics.won_leads }},
            {{ metrics.active_leads }},
            {{ metrics.active_leads }},
            {{ metrics.won_leads }}
        ];

        new Chart(funnelCtx, {
            type: 'horizontalBar',
            data: {
                labels: funnelLabels,
                datasets: [{
                    data: funnelCounts,
                    backgroundColor: [
                        '#94a3b8', '#60a5fa', '#34d399', '#fbbf24', '#f87171', '#10b981'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true, ticks: { precision: 0 } } }
            }
        });
    }

    // Owner Chart (Bar)
    const ownerCtx = document.getElementById('ownerChart');
    if (ownerCtx) {
        // Placeholder - in real implementation, compute from Lead.objects.values('assigned_to').annotate(count=Count('id'))
        new Chart(ownerCtx, {
            type: 'bar',
            data: {
                labels: ['Sales A', 'Sales B', 'Sales C'],
                datasets: [{
                    data: [12, 8, 15],
                    backgroundColor: '#8b5cf6'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
            }
        });
    }

    // Priority Chart (Pie)
    const priorityCtx = document.getElementById('priorityChart');
    if (priorityCtx) {
        new Chart(priorityCtx, {
            type: 'pie',
            data: {
                labels: ['Hot', 'Warm', 'Cold'],
                datasets: [{
                    data: [5, 20, 10],
                    backgroundColor: ['#ef4444', '#f59e0b', '#6b7280']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }
});
</script>
{% endblock %}
